name: Yandex Music with Debug

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Duration in minutes'
        required: true
        default: '10'

jobs:
  yandex-music-debug:
    runs-on: windows-latest
    timeout-minutes: ${{ github.event.inputs.duration || 10 }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: npm ci
    
    - name: Check ports before start
      run: |
        netstat -ano | findstr :9222 && echo "‚ö†Ô∏è Port 9222 is in use!" || echo "‚úÖ Port 9222 is free"
        netstat -ano | findstr :3002 && echo "‚ö†Ô∏è Port 3002 is in use!" || echo "‚úÖ Port 3002 is free"
      shell: cmd
      
    - name: Start server with environment variables
      env:
        YANDEX_MUSIC_PORT: 9222
        SERVER_PORT: 3002
        NODE_ENV: production
      run: |
        echo "Configuration:"
        echo "Yandex Music Debug Port: %YANDEX_MUSIC_PORT%"
        echo "Server Port: %SERVER_PORT%"
        
        echo "üì° Starting servers..."
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º PID
        start /B cmd /c "node setup.js"
        timeout /t 5
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å—ã –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å
        tasklist | findstr node
        netstat -ano | findstr :3002 && echo "‚úÖ Server is running" || echo "‚ùå Server failed to start"
      shell: cmd
      
    - name: Keep alive for testing
      if: github.event_name == 'workflow_dispatch'
      run: |
        echo "‚è∞ Running for ${{ github.event.inputs.duration || 10 }} minutes..."
        timeout /t ${{ github.event.inputs.duration || 600 }}
      shell: cmd
