name: Public Yandex Music Server

on:
  workflow_dispatch:
    inputs:
      duration:
        description: '–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã (–º–∏–Ω—É—Ç)'
        default: '60'
        type: choice
        options:
        - '30'
        - '60'
        - '120'

jobs:
  deploy-public:
    runs-on: windows-latest
    
    env:
      NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      NGROK_DURATION: ${{ github.event.inputs.duration }}
      
    steps:
    - name: üõéÔ∏è Checkout
      uses: actions/checkout@v4
      
    - name: üì¶ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: üì• Install dependencies
      run: npm ci
      shell: cmd
      
    - name: üåê Setup ngrok
      run: |
        # –°–∫–∞—á–∏–≤–∞–µ–º ngrok
        curl -o ngrok.zip https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip
        tar -xf ngrok.zip
        del ngrok.zip
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω
        .\ngrok config add-authtoken $env:NGROK_AUTH_TOKEN
      shell: pwsh
      
    - name: üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –∏ —Ç—É–Ω–Ω–µ–ª—è
      run: |
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–µ
        Start-Process -FilePath "node" -ArgumentList "setup.js" -NoNewWindow
        
        # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
        Start-Sleep -Seconds 5
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
        $response = Invoke-WebRequest -Uri "http://localhost:3002" -TimeoutSec 3
        Write-Output "‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω"
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º ngrok —Ç—É–Ω–Ω–µ–ª—å
        $ngrokProcess = Start-Process -FilePath ".\ngrok.exe" `
          -ArgumentList "http 3002 --log stdout" `
          -RedirectStandardOutput "ngrok.log" `
          -NoNewWindow -PassThru
        
        # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Ç—É–Ω–Ω–µ–ª—è
        Start-Sleep -Seconds 10
        
        # –ü–æ–ª—É—á–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π URL
        $tunnels = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -TimeoutSec 5
        $publicUrl = $tunnels.tunnels[0].public_url
        
        Write-Output "üåê –ü—É–±–ª–∏—á–Ω—ã–π URL: $publicUrl"
        Write-Output "üîó WebSocket URL: $($publicUrl -replace 'https://', 'wss://')"
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        echo "PUBLIC_URL=$publicUrl" >> $env:GITHUB_ENV
        
        # –î–µ—Ä–∂–∏–º —Ç—É–Ω–Ω–µ–ª—å –æ—Ç–∫—Ä—ã—Ç—ã–º —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
        Start-Sleep -Seconds ($env:NGROK_DURATION * 60)
        
        # –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã
        Stop-Process -Id $ngrokProcess.Id -Force
        Get-Process node | Stop-Process -Force
      shell: pwsh
      
    - name: üì§ –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏
      run: |
        echo "üåê –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:"
        echo "${{ env.PUBLIC_URL }}"
        echo ""
        echo "‚è±Ô∏è –ë—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å: ${{ github.event.inputs.duration }} –º–∏–Ω—É—Ç"
        
        # –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ PR –∏–ª–∏ Issue
        if ("${{ github.event_name }}" -eq "pull_request") {
          $comment = @"
          ### üéµ –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω!
          
          **–ü—É–±–ª–∏—á–Ω—ã–π URL:** ${{ env.PUBLIC_URL }}
          **–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:** ${{ github.event.inputs.duration }} –º–∏–Ω—É—Ç
          
          WebSocket: ${{ env.PUBLIC_URL -replace 'https://', 'wss://' }}
          
          –î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–º –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –≤—ã—à–µ.
          "@
          
          gh pr comment ${{ github.event.pull_request.number }} --body "$comment"
        }
      shell: pwsh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
